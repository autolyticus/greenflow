---
# Source: redpanda/templates/poddisruptionbudget.yaml
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: redpanda
  namespace: redpanda
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
spec:
  maxUnavailable: 1
  selector:
    matchLabels: 
      app.kubernetes.io/name: redpanda
      app.kubernetes.io/instance: "redpanda"
      app.kubernetes.io/component: redpanda-statefulset
      redpanda.com/poddisruptionbudget: redpanda
---
# Source: redpanda/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: redpanda-sts-lifecycle
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
type: Opaque
stringData:
  common.sh: |-
    #!/usr/bin/env bash

    # the SERVICE_NAME comes from the metadata.name of the pod, essentially the POD_NAME
    CURL_URL="https://${SERVICE_NAME}.redpanda.redpanda.svc.cluster.local:9644"

    # commands used throughout
    CURL_NODE_ID_CMD="curl --silent --fail --cacert /etc/tls/certs/default/tls.crt ${CURL_URL}/v1/node_config"

    CURL_MAINTENANCE_DELETE_CMD_PREFIX='curl -X DELETE --silent -o /dev/null -w "%{http_code}"'
    CURL_MAINTENANCE_PUT_CMD_PREFIX='curl -X PUT --silent -o /dev/null -w "%{http_code}"'
    CURL_MAINTENANCE_GET_CMD="curl -X GET --silent --cacert /etc/tls/certs/default/tls.crt ${CURL_URL}/v1/maintenance"

  postStart.sh: |-
    #!/usr/bin/env bash
    # This code should be similar if not exactly the same as that found in the panda-operator, see
    # https://github.com/redpanda-data/redpanda/blob/e51d5b7f2ef76d5160ca01b8c7a8cf07593d29b6/src/go/k8s/pkg/resources/secret.go

    # path below should match the path defined on the statefulset
    source /var/lifecycle/common.sh

    postStartHook () {
      set -x

      touch /tmp/postStartHookStarted

      until NODE_ID=$(${CURL_NODE_ID_CMD} | grep -o '\"node_id\":[^,}]*' | grep -o '[^: ]*$'); do
          sleep 0.5
      done

      echo "Clearing maintenance mode on node ${NODE_ID}"
      CURL_MAINTENANCE_DELETE_CMD="${CURL_MAINTENANCE_DELETE_CMD_PREFIX} --cacert /etc/tls/certs/default/tls.crt ${CURL_URL}/v1/brokers/${NODE_ID}/maintenance"
      # a 400 here would mean not in maintenance mode
      until [ "${status:-}" = '"200"' ] || [ "${status:-}" = '"400"' ]; do
          status=$(${CURL_MAINTENANCE_DELETE_CMD})
          sleep 0.5
      done

      touch /tmp/postStartHookFinished
    }

    postStartHook
    true

  preStop.sh: |-
    #!/usr/bin/env bash
    # This code should be similar if not exactly the same as that found in the panda-operator, see
    # https://github.com/redpanda-data/redpanda/blob/e51d5b7f2ef76d5160ca01b8c7a8cf07593d29b6/src/go/k8s/pkg/resources/secret.go

    touch /tmp/preStopHookStarted

    # path below should match the path defined on the statefulset
    source /var/lifecycle/common.sh

    set -x

    preStopHook () {
      until NODE_ID=$(${CURL_NODE_ID_CMD} | grep -o '\"node_id\":[^,}]*' | grep -o '[^: ]*$'); do
          sleep 0.5
      done

      echo "Setting maintenance mode on node ${NODE_ID}"
      CURL_MAINTENANCE_PUT_CMD="${CURL_MAINTENANCE_PUT_CMD_PREFIX} --cacert /etc/tls/certs/default/tls.crt ${CURL_URL}/v1/brokers/${NODE_ID}/maintenance"
      until [ "${status:-}" = '"200"' ]; do
          status=$(${CURL_MAINTENANCE_PUT_CMD})
          sleep 0.5
      done

      until [ "${finished:-}" = "true" ] || [ "${draining:-}" = "false" ]; do
          res=$(${CURL_MAINTENANCE_GET_CMD})
          finished=$(echo $res | grep -o '\"finished\":[^,}]*' | grep -o '[^: ]*$')
          draining=$(echo $res | grep -o '\"draining\":[^,}]*' | grep -o '[^: ]*$')
          sleep 0.5
      done

      touch /tmp/preStopHookFinished
    }
    preStopHook
    true
---
# Source: redpanda/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: redpanda-config-watcher
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
type: Opaque
stringData:
  sasl-user.sh: |-
    #!/usr/bin/env bash

    trap 'error_handler $? $LINENO' ERR

    error_handler() {
      echo "Error: ($1) occurred at line $2"
    }

    set -e

    echo "Waiting for cluster to be ready"
    rpk cluster health --watch --exit-when-healthy
    echo "Nothing to do. Sleeping..."
    sleep infinity
---
# Source: redpanda/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: redpanda-configurator
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
type: Opaque
stringData:
  configurator.sh: |-
    set -xe
    SERVICE_NAME=$1
    KUBERNETES_NODE_NAME=$2
    POD_ORDINAL=${SERVICE_NAME##*-}
    BROKER_INDEX=`expr $POD_ORDINAL + 1`

    CONFIG=/etc/redpanda/redpanda.yaml

    # Setup config files
    cp /tmp/base-config/redpanda.yaml "${CONFIG}"
    cp /tmp/base-config/bootstrap.yaml /etc/redpanda/.bootstrap.yaml

    LISTENER="{\"address\":\"${SERVICE_NAME}.redpanda.redpanda.svc.cluster.local.\",\"name\":\"internal\",\"port\":9092}"
    rpk redpanda config --config "$CONFIG" set redpanda.advertised_kafka_api[0] "$LISTENER"

    ADVERTISED_KAFKA_ADDRESSES=()

    PREFIX_TEMPLATE=""
    ADVERTISED_KAFKA_ADDRESSES+=("{\"address\":\"${SERVICE_NAME}\",\"name\":\"default\",\"port\":31092}")

    PREFIX_TEMPLATE=""
    ADVERTISED_KAFKA_ADDRESSES+=("{\"address\":\"${SERVICE_NAME}\",\"name\":\"default\",\"port\":31092}")

    PREFIX_TEMPLATE=""
    ADVERTISED_KAFKA_ADDRESSES+=("{\"address\":\"${SERVICE_NAME}\",\"name\":\"default\",\"port\":31092}")

    rpk redpanda config --config "$CONFIG" set redpanda.advertised_kafka_api[1] "${ADVERTISED_KAFKA_ADDRESSES[$POD_ORDINAL]}"

    LISTENER="{\"address\":\"${SERVICE_NAME}.redpanda.redpanda.svc.cluster.local.\",\"name\":\"internal\",\"port\":8082}"
    rpk redpanda config --config "$CONFIG" set pandaproxy.advertised_pandaproxy_api[0] "$LISTENER"

    ADVERTISED_HTTP_ADDRESSES=()

    PREFIX_TEMPLATE=""
    ADVERTISED_HTTP_ADDRESSES+=("{\"address\":\"${SERVICE_NAME}\",\"name\":\"default\",\"port\":30082}")

    PREFIX_TEMPLATE=""
    ADVERTISED_HTTP_ADDRESSES+=("{\"address\":\"${SERVICE_NAME}\",\"name\":\"default\",\"port\":30082}")

    PREFIX_TEMPLATE=""
    ADVERTISED_HTTP_ADDRESSES+=("{\"address\":\"${SERVICE_NAME}\",\"name\":\"default\",\"port\":30082}")

    rpk redpanda config --config "$CONFIG" set pandaproxy.advertised_pandaproxy_api[1] "${ADVERTISED_HTTP_ADDRESSES[$POD_ORDINAL]}"
---
# Source: redpanda/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: redpanda
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
data: 
  
  bootstrap.yaml: |
    kafka_enable_authorization: false
    enable_sasl: false
    enable_rack_awareness: false
    auto_create_topics_enabled: true
    default_topic_partitions: 300
          
    default_topic_replications: 3
    
    compacted_log_segment_size: 67108864
    group_topic_partitions: 16
    kafka_batch_max_bytes: 1048576
    kafka_connection_rate_limit: 1000
    log_segment_size: 134217728
    log_segment_size_max: 268435456
    log_segment_size_min: 16777216
    max_compacted_log_segment_size: 536870912
    topic_partitions_per_shard: 1000
    storage_min_free_bytes: 1073741824
  
    audit_enabled: false
  
  redpanda.yaml: |
    config_file: /etc/redpanda/redpanda.yaml
    redpanda:
      empty_seed_starts_cluster: false
      kafka_enable_authorization: false
      enable_sasl: false
      auto_create_topics_enabled: true
      default_topic_partitions: 300
      default_topic_replications: 3
      compacted_log_segment_size: 67108864
      group_topic_partitions: 16
      kafka_batch_max_bytes: 1048576
      kafka_connection_rate_limit: 1000
      log_segment_size: 134217728
      log_segment_size_max: 268435456
      log_segment_size_min: 16777216
      max_compacted_log_segment_size: 536870912
      topic_partitions_per_shard: 1000
      storage_min_free_bytes: 1073741824
        
      crash_loop_limit: "5"
      audit_enabled: false
  
  
      admin:
        - name: internal
          address: 0.0.0.0
          port: 9644
        - name: default
          address: 0.0.0.0
          port: 9645
      admin_api_tls:
        - name: internal
          enabled: true
          cert_file: /etc/tls/certs/default/tls.crt
          key_file: /etc/tls/certs/default/tls.key
          require_client_auth: false
          truststore_file: /etc/tls/certs/default/ca.crt
        - name: default
          enabled: true
          cert_file: /etc/tls/certs/external/tls.crt
          key_file: /etc/tls/certs/external/tls.key
          require_client_auth: false
          truststore_file: /etc/tls/certs/external/ca.crt
      kafka_api:
        - name: internal
          address: 0.0.0.0
          port: 9092
        - name: default
          address: 0.0.0.0
          port: 9094
      kafka_api_tls:
      rpc_server:
        address: 0.0.0.0
        port: 33145
      rpc_server_tls:
        enabled: true
        cert_file: /etc/tls/certs/default/tls.crt
        key_file: /etc/tls/certs/default/tls.key
        require_client_auth: false
        truststore_file: /etc/tls/certs/default/ca.crt
      seed_servers: 
        - host:
            address: redpanda-0.redpanda.redpanda.svc.cluster.local.
            port: 33145
        - host:
            address: redpanda-1.redpanda.redpanda.svc.cluster.local.
            port: 33145
        - host:
            address: redpanda-2.redpanda.redpanda.svc.cluster.local.
            port: 33145
  
    schema_registry_client:
      brokers:
      - address: redpanda-0.redpanda.redpanda.svc.cluster.local.
        port: 9092
      - address: redpanda-1.redpanda.redpanda.svc.cluster.local.
        port: 9092
      - address: redpanda-2.redpanda.redpanda.svc.cluster.local.
        port: 9092
    schema_registry:
      schema_registry_api:
        - name: internal
          address: 0.0.0.0
          port: 8081
        - name: default
          address: 0.0.0.0
          port: 8084
      schema_registry_api_tls:
        - name: internal
          enabled: true
          cert_file: /etc/tls/certs/default/tls.crt
          key_file: /etc/tls/certs/default/tls.key
          require_client_auth: false
          truststore_file: /etc/tls/certs/default/ca.crt
        - name: default
          enabled: true
          cert_file: /etc/tls/certs/external/tls.crt
          key_file: /etc/tls/certs/external/tls.key
          require_client_auth: false
          truststore_file: /etc/tls/certs/external/ca.crt
  
    pandaproxy_client:
      brokers:
      - address: redpanda-0.redpanda.redpanda.svc.cluster.local.
        port: 9092
      - address: redpanda-1.redpanda.redpanda.svc.cluster.local.
        port: 9092
      - address: redpanda-2.redpanda.redpanda.svc.cluster.local.
        port: 9092
    pandaproxy:
      pandaproxy_api:
        - name: internal
          address: 0.0.0.0
          port: 8082
        - name: default
          address: 0.0.0.0
          port: 8083
      pandaproxy_api_tls:
        - name: internal
          enabled: true
          cert_file: /etc/tls/certs/default/tls.crt
          key_file: /etc/tls/certs/default/tls.key
          require_client_auth: false
          truststore_file: /etc/tls/certs/default/ca.crt
        - name: default
          enabled: true
          cert_file: /etc/tls/certs/external/tls.crt
          key_file: /etc/tls/certs/external/tls.key
          require_client_auth: false
          truststore_file: /etc/tls/certs/external/ca.crt
  
    
    rpk:
      # redpanda server configuration
      overprovisioned: true
      enable_memory_locking: false
      additional_start_flags:
        - "--smp=16"
        - "--memory=2048M"
        - "--reserve-memory=205M"
        - "--default-log-level=info"
      # rpk tune entries
      tune_aio_events: true
    
      # kafka connection configuration
      kafka_api:
        brokers: 
          - redpanda-0.redpanda.redpanda.svc.cluster.local.:9092
          - redpanda-1.redpanda.redpanda.svc.cluster.local.:9092
          - redpanda-2.redpanda.redpanda.svc.cluster.local.:9092
        tls:
      admin_api:
        addresses: 
          - redpanda-0.redpanda.redpanda.svc.cluster.local.:9644
          - redpanda-1.redpanda.redpanda.svc.cluster.local.:9644
          - redpanda-2.redpanda.redpanda.svc.cluster.local.:9644
        tls:
          truststore_file: /etc/tls/certs/default/ca.crt
---
# Source: redpanda/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: redpanda-rpk
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
data:
  profile: | 
    name: default
    kafka_api:
      brokers: 
          - redpanda-0:31092
          - redpanda-1:31092
          - redpanda-2:31092
      tls:
    admin_api:
      addresses: 
          - redpanda-0:31644
          - redpanda-1:31644
          - redpanda-2:31644
      tls:
        ca_file: ca.crt
---
# Source: redpanda/templates/service.internal.yaml
# This service is only used to create the DNS enteries for each pod in
# the stateful set and allow the serviceMonitor to target the pods.
# This service should not be used by any client application
apiVersion: v1
kind: Service
metadata:
  name: redpanda
  namespace: "redpanda"
  labels:
    monitoring.redpanda.com/enabled: "true"
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
spec:
  type: ClusterIP
  publishNotReadyAddresses: true
  clusterIP: None
  selector: 
    app.kubernetes.io/name: redpanda
    app.kubernetes.io/instance: "redpanda"
    app.kubernetes.io/component: redpanda-statefulset
  ports:
    - name: admin
      protocol: TCP
      port: 9644
      targetPort: 9644
    - name: http
      protocol: TCP
      port: 8082
      targetPort: 8082
    - name: kafka
      protocol: TCP
      port: 9092
      targetPort: 9092
    - name: rpc
      protocol: TCP
      port: 33145
      targetPort: 33145
    - name: schemaregistry
      protocol: TCP
      port: 8081
      targetPort: 8081
---
# Source: redpanda/templates/services.nodeport.yaml
apiVersion: v1
kind: Service
metadata:
  name: redpanda-external
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
spec:
  type: NodePort
  publishNotReadyAddresses: true
  externalTrafficPolicy: Local
  sessionAffinity: None
  ports:
    - name: admin-default
      protocol: TCP
      port: 9645
      nodePort: 31644
    - name: kafka-default
      protocol: TCP
      port: 9094
      nodePort: 31092
    - name: http-default
      protocol: TCP
      port: 8083
      nodePort: 30082
    - name: schema-default
      protocol: TCP
      port: 8084
      nodePort: 30081
  selector: 
    app.kubernetes.io/name: redpanda
    app.kubernetes.io/instance: "redpanda"
    app.kubernetes.io/component: redpanda-statefulset
---
# Source: redpanda/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redpanda
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
spec:
  selector:
    matchLabels: 
      app.kubernetes.io/name: redpanda
      app.kubernetes.io/instance: "redpanda"
      app.kubernetes.io/component: redpanda-statefulset
  serviceName: redpanda
  replicas: 3
  updateStrategy:
    type: RollingUpdate
  podManagementPolicy: "Parallel"
  template:
    metadata:
      labels: 
        app.kubernetes.io/name: redpanda
        app.kubernetes.io/instance: "redpanda"
        app.kubernetes.io/component: redpanda-statefulset
        redpanda.com/poddisruptionbudget: redpanda
      annotations:
        config.redpanda.com/checksum: ee6d4f09c41aac45c8a4fa53671bf59b7b13dc572528eb5415259f3cfd865bc3
    spec:
      terminationGracePeriodSeconds: 90
      securityContext: 
        fsGroup: 101
        fsGroupChangePolicy: OnRootMismatch
      serviceAccountName: default
      initContainers:
        - name: tuning
          image: registry.gitlab.inria.fr/gkovilkk/greenflow/redpanda:v23.3.6
          command:
            - /bin/bash
            - -c
            - rpk redpanda tune all
          securityContext:
            capabilities:
              add: ["SYS_RESOURCE"]
            privileged: true
            runAsUser: 0
            runAsGroup: 0
          volumeMounts: 
            
            - name: redpanda-default-cert
              mountPath: /etc/tls/certs/default
            - name: redpanda-external-cert
              mountPath: /etc/tls/certs/external
            - name: redpanda
              mountPath: /etc/redpanda
        - name: redpanda-configurator
          image: registry.gitlab.inria.fr/gkovilkk/greenflow/redpanda:v23.3.6
          command:
            - /bin/bash
            - -c
            - 'trap "exit 0" TERM; exec $CONFIGURATOR_SCRIPT "${SERVICE_NAME}" "${KUBERNETES_NODE_NAME}" & wait $!'
          env:
            - name: CONFIGURATOR_SCRIPT
              value: /etc/secrets/configurator/scripts/configurator.sh
            - name: SERVICE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: KUBERNETES_NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: HOST_IP_ADDRESS
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: status.hostIP
          securityContext: 
            runAsUser: 101
            runAsGroup: 101
          volumeMounts: 
            
            - name: redpanda-default-cert
              mountPath: /etc/tls/certs/default
            - name: redpanda-external-cert
              mountPath: /etc/tls/certs/external
            - name: config
              mountPath: /etc/redpanda
            - name: redpanda
              mountPath: /tmp/base-config
            - name: redpanda-configurator
              mountPath: /etc/secrets/configurator/scripts/
      containers:
        - name: redpanda
          image: registry.gitlab.inria.fr/gkovilkk/greenflow/redpanda:v23.3.6
          env:
            - name: SERVICE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            - name: HOST_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.hostIP
          # finish the lifecycle scripts with "true" to prevent them from terminating the pod prematurely
          lifecycle:
            postStart:
              exec:
                command:
                  - /bin/bash
                  - -c
                  - |
                    timeout -v 45 bash -x /var/lifecycle/postStart.sh
                    true
            preStop:
              exec:
                command:
                  - /bin/bash
                  - -c
                  - |
                    timeout -v 45 bash -x /var/lifecycle/preStop.sh
                    true # do not fail and cause the pod to terminate
          # the startupProbe checks to see that the admin api is listening and that the broker has a node_id assigned. This
          # check is only used to delay the start of the liveness and readiness probes until it passes.
          startupProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  RESULT=$(curl --silent --fail -k -m 5 --cacert /etc/tls/certs/default/tls.crt "https://${SERVICE_NAME}.redpanda.redpanda.svc.cluster.local.:9644/v1/status/ready")
                  echo $RESULT
                  echo $RESULT | grep ready
            initialDelaySeconds: 1
            failureThreshold: 120
            periodSeconds: 10
          # the livenessProbe just checks to see that the admin api is listening and returning 200s.
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - curl --silent --fail -k -m 5 --cacert /etc/tls/certs/default/tls.crt "https://${SERVICE_NAME}.redpanda.redpanda.svc.cluster.local.:9644/v1/status/ready"
            initialDelaySeconds: 10
            failureThreshold: 3
            periodSeconds: 10
          # the readiness probe just checks that the cluster is healthy according to rpk cluster health.
          # It's ok that this cluster-wide check affects all the pods as it's only used for the
          # PodDisruptionBudget and we don't want to roll any pods if the Redpanda cluster isn't healthy.
          # https://kubernetes.io/docs/concepts/workloads/pods/disruptions/#pod-disruption-budgets
          # All services set `publishNotReadyAddresses:true` to prevent this from affecting cluster access
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - |
                  set -x
                  RESULT=$(rpk cluster health)
                  echo $RESULT
                  echo $RESULT | grep 'Healthy:.*true'
            initialDelaySeconds: 1
            failureThreshold: 3
            periodSeconds: 10
            successThreshold: 1
          command:
            - rpk
            - redpanda
            - start
            - "--advertise-rpc-addr=$(SERVICE_NAME).redpanda.redpanda.svc.cluster.local.:33145"
          ports:
            - name: admin
              containerPort: 9644
            - name: admin-default
              containerPort: 9645
            - name: http
              containerPort: 8082
            - name: http-default
              containerPort: 8083
            - name: kafka
              containerPort: 9092
            - name: kafka-default
              containerPort: 9094
            - name: rpc
              containerPort: 33145
            - name: schemaregistry
              containerPort: 8081
            - name: schema-default
              containerPort: 8084
          securityContext: 
            runAsUser: 101
            runAsGroup: 101
          volumeMounts: 
            
            - name: redpanda-default-cert
              mountPath: /etc/tls/certs/default
            - name: redpanda-external-cert
              mountPath: /etc/tls/certs/external
            - name: config
              mountPath: /etc/redpanda
            - name: redpanda
              mountPath: /tmp/base-config
            - name: lifecycle-scripts
              mountPath: /var/lifecycle
            - name: datadir
              mountPath: /var/lib/redpanda/data
          resources:
            limits:
              cpu: 16
              memory: 2.5Gi
        - name: config-watcher
          image: registry.gitlab.inria.fr/gkovilkk/greenflow/redpanda:v23.3.6
          command:
            - /bin/sh
          args:
            - -c
            - 'trap "exit 0" TERM; exec /etc/secrets/config-watcher/scripts/sasl-user.sh & wait $!'
          volumeMounts: 
            
            - name: redpanda-default-cert
              mountPath: /etc/tls/certs/default
            - name: redpanda-external-cert
              mountPath: /etc/tls/certs/external
            - name: config
              mountPath: /etc/redpanda
            - name: redpanda-config-watcher
              mountPath: /etc/secrets/config-watcher/scripts
      volumes: 
        
        - name: redpanda-default-cert
          secret:
            secretName: redpanda-default-cert
            defaultMode: 0o440
        - name: redpanda-external-cert
          secret:
            secretName: redpanda-external-cert
            defaultMode: 0o440
        - name: lifecycle-scripts
          secret:
            secretName: redpanda-sts-lifecycle
            defaultMode: 0o775
        - name: datadir
          persistentVolumeClaim:
            claimName: datadir
        - name: redpanda
          configMap:
            name: redpanda
        - name: config
          emptyDir: {}
        - name: redpanda-configurator
          secret:
            secretName: redpanda-configurator
            defaultMode: 0o775
        - name: redpanda-config-watcher
          secret:
            secretName: redpanda-config-watcher
            defaultMode: 0o775
        - name: redpanda-fs-validator
          secret:
            secretName: redpanda-fs-validator
            defaultMode: 0o775
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels: 
              app.kubernetes.io/name: redpanda
              app.kubernetes.io/instance: "redpanda"
              app.kubernetes.io/component: redpanda-statefulset
      nodeSelector:
        node.kubernetes.io/broker: "true"
      affinity:
        
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/component: redpanda-statefulset
                  app.kubernetes.io/instance: redpanda
                  app.kubernetes.io/name: redpanda
              topologyKey: kubernetes.io/hostname
            weight: 1
      tolerations:
        []
  volumeClaimTemplates:
    - metadata:
        name: datadir
        labels:
          app.kubernetes.io/name: redpanda
          app.kubernetes.io/instance: "redpanda"
          app.kubernetes.io/component: redpanda
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: "20Gi"
---
# Source: redpanda/templates/cert-issuers.yaml
# This is the root CA certificate
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: redpanda-default-root-certificate
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
spec:
  duration: 43800h
  isCA: true
  commonName: redpanda-default-root-certificate
  secretName: redpanda-default-root-certificate
  privateKey:
    algorithm: ECDSA
    size: 256
  issuerRef:
    name: redpanda-default-selfsigned-issuer
    kind: Issuer
    group: cert-manager.io
---
# Source: redpanda/templates/cert-issuers.yaml
# This is the root CA certificate
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: redpanda-external-root-certificate
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
spec:
  duration: 43800h
  isCA: true
  commonName: redpanda-external-root-certificate
  secretName: redpanda-external-root-certificate
  privateKey:
    algorithm: ECDSA
    size: 256
  issuerRef:
    name: redpanda-external-selfsigned-issuer
    kind: Issuer
    group: cert-manager.io
---
# Source: redpanda/templates/certs.yaml
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: redpanda-default-cert
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
spec:
  dnsNames:
    - redpanda-cluster.redpanda.redpanda.svc.cluster.local
    - redpanda-cluster.redpanda.redpanda.svc
    - redpanda-cluster.redpanda.redpanda
    - "*.redpanda-cluster.redpanda.redpanda.svc.cluster.local"
    - "*.redpanda-cluster.redpanda.redpanda.svc"
    - "*.redpanda-cluster.redpanda.redpanda"
    - redpanda.redpanda.svc.cluster.local
    - redpanda.redpanda.svc
    - redpanda.redpanda
    - "*.redpanda.redpanda.svc.cluster.local"
    - "*.redpanda.redpanda.svc"
    - "*.redpanda.redpanda"
  duration: 43800h
  isCA: false
  secretName: redpanda-default-cert
  privateKey:
    algorithm: ECDSA
    size: 256
  issuerRef:
    name: redpanda-default-root-issuer
    kind: Issuer
    group: cert-manager.io
---
# Source: redpanda/templates/certs.yaml
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: redpanda-external-cert
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
spec:
  dnsNames:
    - redpanda-cluster.redpanda.redpanda.svc.cluster.local
    - redpanda-cluster.redpanda.redpanda.svc
    - redpanda-cluster.redpanda.redpanda
    - "*.redpanda-cluster.redpanda.redpanda.svc.cluster.local"
    - "*.redpanda-cluster.redpanda.redpanda.svc"
    - "*.redpanda-cluster.redpanda.redpanda"
    - redpanda.redpanda.svc.cluster.local
    - redpanda.redpanda.svc
    - redpanda.redpanda
    - "*.redpanda.redpanda.svc.cluster.local"
    - "*.redpanda.redpanda.svc"
    - "*.redpanda.redpanda"
  duration: 43800h
  isCA: false
  secretName: redpanda-external-cert
  privateKey:
    algorithm: ECDSA
    size: 256
  issuerRef:
    name: redpanda-external-root-issuer
    kind: Issuer
    group: cert-manager.io
---
# Source: redpanda/templates/cert-issuers.yaml
# The self-signed issuer is used to create the self-signed CA
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: redpanda-default-selfsigned-issuer
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
spec:
  selfSigned: {}
---
# Source: redpanda/templates/cert-issuers.yaml
# This is the self-signed CA used to issue certs
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: redpanda-default-root-issuer
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
spec:
  ca:
    secretName: redpanda-default-root-certificate
---
# Source: redpanda/templates/cert-issuers.yaml
# The self-signed issuer is used to create the self-signed CA
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: redpanda-external-selfsigned-issuer
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
spec:
  selfSigned: {}
---
# Source: redpanda/templates/cert-issuers.yaml
# This is the self-signed CA used to issue certs
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: redpanda-external-root-issuer
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
spec:
  ca:
    secretName: redpanda-external-root-certificate
---
# Source: redpanda/templates/servicemonitor.yaml
# This servicemonitor is used by Prometheus Operator to scrape the metrics
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: redpanda
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
spec:
  endpoints:
  - interval: 5s
    path: /public_metrics
    port: admin
    scheme: https
    tlsConfig:
      insecureSkipVerify: true
  selector:
    matchLabels:
      monitoring.redpanda.com/enabled: "true"
      app.kubernetes.io/name: redpanda
      app.kubernetes.io/instance: "redpanda"
---
# Source: redpanda/templates/tests/test-nodeport-tls.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: test-nodeport-tls-redpanda-no-a-test
  annotations:
    helm.sh/hook: test
    helm.sh/hook-delete-policy: before-hook-creation
    helm.sh/hook-weight: "-100"
---
# Source: redpanda/templates/tests/test-nodeport-tls.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: test-nodeport-tls-redpanda-no-a-test
  annotations:
    helm.sh/hook: test
    helm.sh/hook-delete-policy: before-hook-creation
    helm.sh/hook-weight: "-100"
rules:
  - apiGroups:
      - ""
    resources:
      - pods
      - services
    verbs:
      - get
---
# Source: redpanda/templates/tests/test-nodeport-tls.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: test-nodeport-tls-redpanda-no-a-test
  annotations:
    helm.sh/hook: test
    helm.sh/hook-delete-policy: before-hook-creation
    helm.sh/hook-weight: "-100"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: test-nodeport-tls-redpanda-no-a-test
subjects:
  - kind: ServiceAccount
    name: test-nodeport-tls-redpanda-no-a-test
    namespace: redpanda
---
# Source: redpanda/templates/tests/test-internal-external-tls-secrets.yaml
apiVersion: v1
kind: Pod
metadata:
  name: redpanda-test-internal-externals-cert-secrets
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  restartPolicy: Never
  securityContext: 
    fsGroup: 101
    fsGroupChangePolicy: OnRootMismatch
  containers:
    - name: redpanda
      image: registry.gitlab.inria.fr/gkovilkk/greenflow/redpanda:v23.3.6
      command:
        - bash
        - -c
        - |
          set -x

          retry() {
            local retries="$1"
            local command="$2"

            # Run the command, and save the exit code
            bash -c $command
            local exit_code=$?

            # If the exit code is non-zero (i.e. command failed), and we have not
            # reached the maximum number of retries, run the command again
            if [[ $exit_code -ne 0 && $retries -gt 0 ]]; then
              retry $(($retries - 1)) "$command"
              else
              # Return the exit code from the command
              return $exit_code
            fi
          }
      volumeMounts: 
        - name: config
          mountPath: /etc/redpanda
        - name: redpanda-default-cert
          mountPath: /etc/tls/certs/default
        - name: redpanda-external-cert
          mountPath: /etc/tls/certs/external
      securityContext: 
        runAsUser: 101
        runAsGroup: 101
  volumes: 
    - name: config
      configMap:
        name: redpanda
    - name: redpanda-default-cert
      secret:
        secretName: redpanda-default-cert
        defaultMode: 0o440
    - name: redpanda-external-cert
      secret:
        secretName: redpanda-external-cert
        defaultMode: 0o440
---
# Source: redpanda/templates/tests/test-kafka-nodelete.yaml
apiVersion: v1
kind: Pod
metadata:
  name: redpanda-test-kafka-nodelete
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  restartPolicy: Never
  securityContext: 
    fsGroup: 101
    fsGroupChangePolicy: OnRootMismatch
  containers:
    - name: redpanda
      image: registry.gitlab.inria.fr/gkovilkk/greenflow/redpanda:v23.3.6
      env:
        - name: REDPANDA_BROKERS
          value: "redpanda.redpanda.svc.cluster.local:9092"
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
      command:
        - /usr/bin/timeout
        - "120"
        - bash
        - -c
        - |
          set -e
          # wait for post-upgrade job to update the default_topic_replications value
          timeout 120 bash -c "until [[ $(rpk cluster config get default_topic_replications) = 3 ]]; do sleep 1; done"
  
          exists=$(rpk topic list | grep my_sample_topic | awk '{print $1}')
          if [[ "$exists" != "my_sample_topic" ]]; then
            until rpk topic create my_sample_topic 
              do sleep 2
            done
          fi
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          echo "Pandas are awesome!" | rpk topic produce my_sample_topic
          sleep 2
          rpk topic consume my_sample_topic -n 1 | grep "Pandas are awesome!"
         
          # now check if we can delete the topic (we should not)
          rpk topic delete my_sample_topic

      volumeMounts: 
        - name: config
          mountPath: /etc/redpanda
        - name: redpanda-default-cert
          mountPath: /etc/tls/certs/default
        - name: redpanda-external-cert
          mountPath: /etc/tls/certs/external
      resources: 
            null
      securityContext: 
        runAsUser: 101
        runAsGroup: 101
  volumes: 
    - name: config
      configMap:
        name: redpanda
    - name: redpanda-default-cert
      secret:
        secretName: redpanda-default-cert
        defaultMode: 0o440
    - name: redpanda-external-cert
      secret:
        secretName: redpanda-external-cert
        defaultMode: 0o440
---
# Source: redpanda/templates/tests/test-kafka-produce-consume.yaml
apiVersion: v1
kind: Pod
metadata:
  name: redpanda-test-kafka-produce-consume
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  restartPolicy: Never
  securityContext: 
    fsGroup: 101
    fsGroupChangePolicy: OnRootMismatch
  containers:
    - name: redpanda
      image: registry.gitlab.inria.fr/gkovilkk/greenflow/redpanda:v23.3.6
      env:
        - name: REDPANDA_BROKERS
          value: "redpanda.redpanda.svc.cluster.local:9092"
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
      command:
        - /usr/bin/timeout
        - "120"
        - bash
        - -c
        - |
          set -e
          # wait for post-upgrade job to update the default_topic_replications value
          timeout 600 bash -c "until [[ $(rpk cluster config get default_topic_replications) = 3 ]]; do sleep 1; done"
          until rpk topic create produce.consume.test.$POD_NAME 
            do sleep 2
          done
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          echo "Pandas are awesome!" | rpk topic produce produce.consume.test.$POD_NAME
          sleep 2
          rpk topic consume produce.consume.test.$POD_NAME -n 1 | grep "Pandas are awesome!"
          rpk topic delete produce.consume.test.$POD_NAME
      volumeMounts: 
        - name: config
          mountPath: /etc/redpanda
        - name: redpanda-default-cert
          mountPath: /etc/tls/certs/default
        - name: redpanda-external-cert
          mountPath: /etc/tls/certs/external
      resources: 
            null
      securityContext: 
        runAsUser: 101
        runAsGroup: 101
  volumes: 
    - name: config
      configMap:
        name: redpanda
    - name: redpanda-default-cert
      secret:
        secretName: redpanda-default-cert
        defaultMode: 0o440
    - name: redpanda-external-cert
      secret:
        secretName: redpanda-external-cert
        defaultMode: 0o440
---
# Source: redpanda/templates/tests/test-lifecycle-scripts.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "redpanda-test-lifecycle"
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
  annotations:
    helm.sh/hook: test
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  restartPolicy: Never
  securityContext: 
    fsGroup: 101
    fsGroupChangePolicy: OnRootMismatch
  containers:
    - name: redpanda
      image: registry.gitlab.inria.fr/gkovilkk/greenflow/redpanda:v23.3.6
      env:
        - name: SERVICE_NAME
          value: redpanda-0
      command:
        - /bin/timeout
        - "180"
        - bash
        - -xec
        - |
          /bin/timeout -v 45 bash -x /var/lifecycle/preStop.sh
          ls -l /tmp/preStop*
          test -f /tmp/preStopHookStarted
          test -f /tmp/preStopHookFinished

          /bin/timeout -v 45 bash -x /var/lifecycle/postStart.sh
          ls -l /tmp/postStart*
          test -f /tmp/postStartHookStarted
          test -f /tmp/postStartHookFinished
      volumeMounts: 
        - name: config
          mountPath: /etc/redpanda
        - name: redpanda-default-cert
          mountPath: /etc/tls/certs/default
        - name: redpanda-external-cert
          mountPath: /etc/tls/certs/external
        - name: lifecycle-scripts
          mountPath: /var/lifecycle
      securityContext: 
        runAsUser: 101
        runAsGroup: 101
  volumes: 
    - name: config
      configMap:
        name: redpanda
    - name: redpanda-default-cert
      secret:
        secretName: redpanda-default-cert
        defaultMode: 0o440
    - name: redpanda-external-cert
      secret:
        secretName: redpanda-external-cert
        defaultMode: 0o440
    - name: lifecycle-scripts
      secret:
        secretName: redpanda-sts-lifecycle
        defaultMode: 0o775
---
# Source: redpanda/templates/tests/test-nodeport-tls.yaml
apiVersion: v1
kind: Pod
metadata:
  name: redpanda-test-nodeport-tls
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
  annotations:
    helm.sh/hook: test
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  serviceAccountName: test-nodeport-tls-redpanda-no-a-test
  restartPolicy: Never
  securityContext: 
    fsGroup: 101
    fsGroupChangePolicy: OnRootMismatch
  containers:
    - name: redpanda
      image: mintel/docker-alpine-bash-curl-jq:latest
      command:
        - bash
        - -c
        - |
          set -x
          export APISERVER=https://kubernetes.default.svc
          export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
          export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
          export TOKEN=$(cat ${SERVICEACCOUNT}/token)
          export CACERT=${SERVICEACCOUNT}/ca.crt
          
          ip_list=""
          
          replicas=3
          if [ "${replicas}" -lt "1" ]; then
            echo "replicas cannot be less than 1"
            exit 1
          fi
          
          range=$(expr $replicas - 1)          
          ordinal_list=$(seq 0 $range)

          set -e 
          
          for i in $ordinal_list
          do
            POD_DESC=$(curl --cacert ${CACERT} --header "Authorization: Bearer ${TOKEN}" \
            -X GET ${APISERVER}/api/v1/namespaces/redpanda/pods/redpanda-$i)
            ip=$(echo $POD_DESC | jq -r .status.hostIP )
            ip_list="$ip $ip_list"
          done
          
          echo test will be run against $ip_list
          echo testing NodePort connectivity
      volumeMounts: 
        - name: config
          mountPath: /etc/redpanda
        - name: redpanda-default-cert
          mountPath: /etc/tls/certs/default
        - name: redpanda-external-cert
          mountPath: /etc/tls/certs/external
      securityContext: 
        runAsUser: 101
        runAsGroup: 101
  volumes: 
    - name: config
      configMap:
        name: redpanda
    - name: redpanda-default-cert
      secret:
        secretName: redpanda-default-cert
        defaultMode: 0o440
    - name: redpanda-external-cert
      secret:
        secretName: redpanda-external-cert
        defaultMode: 0o440
---
# Source: redpanda/templates/tests/test-pandaproxy-internal-tls-status.yaml
apiVersion: v1
kind: Pod
metadata:
  name: redpanda-test-pandaproxy-internal-tls-status
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  restartPolicy: Never
  securityContext: 
    fsGroup: 101
    fsGroupChangePolicy: OnRootMismatch
  containers:
    - name: redpanda
      image: registry.gitlab.inria.fr/gkovilkk/greenflow/redpanda:v23.3.6
      command: [ "/bin/bash", "-c" ]
      args:
        - |

          curl -svm3 --fail --retry "120" --retry-max-time "120" --retry-all-errors --ssl-reqd \
          --cacert /etc/tls/certs/default/ca.crt \
          https://redpanda.redpanda.svc.cluster.local.:8082/brokers

          curl -svm3 --fail --retry "120" --retry-max-time "120" --retry-all-errors --ssl-reqd \
          --cacert /etc/tls/certs/default/ca.crt \
          https://redpanda.redpanda.svc.cluster.local.:8082/topics
      volumeMounts: 
        - name: config
          mountPath: /etc/redpanda
        - name: redpanda-default-cert
          mountPath: /etc/tls/certs/default
        - name: redpanda-external-cert
          mountPath: /etc/tls/certs/external
      resources: 
            null
      securityContext: 
        runAsUser: 101
        runAsGroup: 101
  volumes: 
    - name: config
      configMap:
        name: redpanda
    - name: redpanda-default-cert
      secret:
        secretName: redpanda-default-cert
        defaultMode: 0o440
    - name: redpanda-external-cert
      secret:
        secretName: redpanda-external-cert
        defaultMode: 0o440
---
# Source: redpanda/templates/tests/test-prometheus-targets.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "redpanda-test-prometheus-targets"
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  restartPolicy: Never
  securityContext: 
    fsGroup: 101
    fsGroupChangePolicy: OnRootMismatch
  containers:
    - name: redpanda
      image: registry.gitlab.com/gitlab-ci-utils/curl-jq:latest
      command: [ "/bin/bash", "-c" ]
      args:
        - |
          set -xe
          
          HEALTHY=$( curl  -svm3 --fail --retry "120" --retry-max-time "120" --retry-all-errors -o - -w "\nstatus=%{http_code} %{redirect_url} size=%{size_download} time=%{time_total} content-type=\"%{content_type}\"\n"  http://prometheus-operated.prometheus.svc.cluster.local:9090/-/healthy)
          if [ $HEALTHY != 200 ]; then
            echo "prometheus is not healthy, exiting"
            exit 1
          fi
          
          echo "prometheus is healthy, checking if ready..."

          READY=$( curl  -svm3 --fail --retry "120" --retry-max-time "120" --retry-all-errors -o - -w "\nstatus=%{http_code} %{redirect_url} size=%{size_download} time=%{time_total} content-type=\"%{content_type}\"\n"  http://prometheus-operated.prometheus.svc.cluster.local:9090/-/ready)
          if [ $READY != 200 ]; then
            echo "prometheus is not ready, exiting"
            exit 1
          fi
          
          echo "prometheus is ready, requesting target information..."

          
          curl_prometheus() {

            # Run the command, and save the exit code
            # from: https://prometheus.io/docs/prometheus/latest/querying/api/
            local RESULT=$( curl  -svm3 --fail --retry "120" --retry-max-time "120" --retry-all-errors -o - -w "\nstatus=%{http_code} %{redirect_url} size=%{size_download} time=%{time_total} content-type=\"%{content_type}\"\n"  http://prometheus-operated.prometheus.svc.cluster.local:9090/api/v1/targets?scrapePool=serviceMonitor/redpanda/redpanda/0 | jq '.data.activeTargets[].health | select(. == "up")' | wc -l  )

            echo $RESULT
          }
          for d in $(seq 1 30); do
            RESULT=$(curl_prometheus)
            if [ $RESULT == 3 ]; then
              break
            fi
            sleep 15
          done

          set +x
          if [ $RESULT != 3 ]; then
              curl --fail http://prometheus-operated.prometheus.svc.cluster.local:9090/api/v1/targets?scrapePool=serviceMonitor/redpanda/redpanda/0 | jq .
              echo "the number of targets unexpected; got ${RESULT} targets 'up', but was expecting 3"
              exit 1
          fi
---
# Source: redpanda/templates/tests/test-rack-awareness.yaml
apiVersion: v1
kind: Pod
metadata:
  name: redpanda-test-rack-awareness
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  restartPolicy: Never
  securityContext: 
    fsGroup: 101
    fsGroupChangePolicy: OnRootMismatch
  containers:
    - name: redpanda
      image: registry.gitlab.inria.fr/gkovilkk/greenflow/redpanda:v23.3.6
      command:
      - /bin/bash
      - -c
      - |
        set -e

        rpk redpanda admin config print --host redpanda.redpanda.svc.cluster.local.:9644 | grep '"enable_rack_awareness": false'

        rpk cluster config get enable_rack_awareness
      volumeMounts: 
        - name: config
          mountPath: /etc/redpanda
        - name: redpanda-default-cert
          mountPath: /etc/tls/certs/default
        - name: redpanda-external-cert
          mountPath: /etc/tls/certs/external
      securityContext: 
        runAsUser: 101
        runAsGroup: 101
  volumes: 
    - name: config
      configMap:
        name: redpanda
    - name: redpanda-default-cert
      secret:
        secretName: redpanda-default-cert
        defaultMode: 0o440
    - name: redpanda-external-cert
      secret:
        secretName: redpanda-external-cert
        defaultMode: 0o440
---
# Source: redpanda/templates/tests/test-schemaregistry-internal-tls-status.yaml
apiVersion: v1
kind: Pod
metadata:
  name: redpanda-test-sr-internal-tls-status-154
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  restartPolicy: Never
  securityContext: 
    fsGroup: 101
    fsGroupChangePolicy: OnRootMismatch
  containers:
    - name: redpanda
      image: registry.gitlab.inria.fr/gkovilkk/greenflow/redpanda:v23.3.6
      command: ["/bin/bash", "-c"]
      args:
        - |

          set -e

          trap reportSchema ERR

          reportSchema () {
            echo Retrieving schemas/types
            schemaCurlIgnore https://redpanda.redpanda.svc.cluster.local.:8081/schemas/types
            echo Retrieving schemas/ids/1
            schemaCurlIgnore https://redpanda.redpanda.svc.cluster.local.:8081/schemas/ids/1
            echo Retrieving subjects
            schemaCurlIgnore https://redpanda.redpanda.svc.cluster.local.:8081/subjects
            echo Retrieving subjects?deleted=true
            schemaCurlIgnore https://redpanda.redpanda.svc.cluster.local.:8081/subjects?deleted=true
            echo Retrieving subjects/sensor-154-value/versions
            schemaCurlIgnore https://redpanda.redpanda.svc.cluster.local.:8081/subjects/sensor-154-value/versions
            echo Retrieving subjects/sensor-154-value/versions?deleted=true
            schemaCurlIgnore https://redpanda.redpanda.svc.cluster.local.:8081/subjects/sensor-154-value/versions?deleted=true
            echo Retrieving subjects/sensor-154-value/versions/latest
            schemaCurlIgnore https://redpanda.redpanda.svc.cluster.local.:8081/subjects/sensor-154-value/versions/latest
            echo Retrieving subjects/sensor-154-value/versions/latest?deleted=true
            schemaCurlIgnore https://redpanda.redpanda.svc.cluster.local.:8081/subjects/sensor-154-value/versions/latest?deleted=true
            echo Retrieving subjects/sensor-154-value/versions/latest/schema
            schemaCurlIgnore https://redpanda.redpanda.svc.cluster.local.:8081/subjects/sensor-154-value/versions/latest/schema
            echo Retrieving subjects/sensor-154-value/versions/latest/schema?deleted=true
            schemaCurlIgnore https://redpanda.redpanda.svc.cluster.local.:8081/subjects/sensor-154-value/versions/latest/schema?deleted=true
            echo
          }


          schemaCurlIgnore () {
            curl  -svm3 --fail --retry "120" --retry-max-time "120" --retry-all-errors -o - -w "\nstatus=%{http_code} %{redirect_url} size=%{size_download} time=%{time_total} content-type=\"%{content_type}\"\n"  \
              --cacert /etc/tls/certs/default/ca.crt \
              $* || true
          }

          schemaCurl () {
            curl  -svm3 --fail --retry "120" --retry-max-time "120" --retry-all-errors -o - -w "\nstatus=%{http_code} %{redirect_url} size=%{size_download} time=%{time_total} content-type=\"%{content_type}\"\n"  \
              --cacert /etc/tls/certs/default/ca.crt \
              $*
          }

          echo "Get existng schemas"
          schemaCurl https://redpanda.redpanda.svc.cluster.local.:8081/subjects

          echo "Create schema"
          curl  -svm3 --fail --retry "120" --retry-max-time "120" --retry-all-errors -o - -w "\nstatus=%{http_code} %{redirect_url} size=%{size_download} time=%{time_total} content-type=\"%{content_type}\"\n"  \
            -X POST -H 'Content-Type:application/vnd.schemaregistry.v1+json' \
            -d '{"schema": "{\"type\":\"record\",\"name\":\"sensor_sample\",\"fields\":[{\"name\":\"timestamp\",\"type\":\"long\",\"logicalType\":\"timestamp-millis\"},{\"name\":\"identifier\",\"type\":\"string\",\"logicalType\":\"uuid\"},{\"name\":\"value\",\"type\":\"long\"}]}"}' \
              --cacert /etc/tls/certs/default/ca.crt \
            https://redpanda.redpanda.svc.cluster.local.:8081/subjects/sensor-154-value/versions

          echo "Get schema 1"
          schemaCurl https://redpanda.redpanda.svc.cluster.local.:8081/schemas/ids/1

          echo "Get existng schemas"
          schemaCurl https://redpanda.redpanda.svc.cluster.local.:8081/subjects

          echo "Delete schema 1"
          curl  -svm3 --fail --retry "120" --retry-max-time "120" --retry-all-errors -o - -w "\nstatus=%{http_code} %{redirect_url} size=%{size_download} time=%{time_total} content-type=\"%{content_type}\"\n"  -X DELETE \
              --cacert /etc/tls/certs/default/ca.crt \
              https://redpanda.redpanda.svc.cluster.local.:8081/subjects/sensor-154-value/versions/1

          echo "Delete schema 1 permanently"
          curl  -svm3 --fail --retry "120" --retry-max-time "120" --retry-all-errors -o - -w "\nstatus=%{http_code} %{redirect_url} size=%{size_download} time=%{time_total} content-type=\"%{content_type}\"\n"  -X DELETE \
              --cacert /etc/tls/certs/default/ca.crt \
              https://redpanda.redpanda.svc.cluster.local.:8081/subjects/sensor-154-value/versions/1?permanent=true

      volumeMounts: 
        - name: config
          mountPath: /etc/redpanda
        - name: redpanda-default-cert
          mountPath: /etc/tls/certs/default
        - name: redpanda-external-cert
          mountPath: /etc/tls/certs/external
      resources: 
            null
      securityContext: 
        runAsUser: 101
        runAsGroup: 101
  volumes: 
    - name: config
      configMap:
        name: redpanda
    - name: redpanda-default-cert
      secret:
        secretName: redpanda-default-cert
        defaultMode: 0o440
    - name: redpanda-external-cert
      secret:
        secretName: redpanda-external-cert
        defaultMode: 0o440
---
# Source: redpanda/templates/post-install-upgrade-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: redpanda-configuration
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
  annotations:
    # This is what defines this resource as a hook. Without this line, the
    # job is considered part of the release.
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation
    "helm.sh/hook-weight": "-5"
spec:
  template:
    metadata:
      generateName: "redpanda-post-"
      labels:
        app.kubernetes.io/name: redpanda
        app.kubernetes.io/instance: "redpanda"
        app.kubernetes.io/component: redpanda-post-install
    spec:
      nodeSelector:
        node.kubernetes.io/broker: "true"
      affinity:
        {}
      restartPolicy: Never
      securityContext: 
        fsGroup: 101
        fsGroupChangePolicy: OnRootMismatch
      containers:
      - name: redpanda-post-install
        image: registry.gitlab.inria.fr/gkovilkk/greenflow/redpanda:v23.3.6
        
        env: []
        command: ["bash","-c"]
        args:
          - |
            set -e
            if [[ -n "$REDPANDA_LICENSE" ]] then
              rpk cluster license set "$REDPANDA_LICENSE"
            fi

            

            
            rpk cluster config export -f /tmp/cfg.yml

            
            for KEY in "${!RPK_@}"; do
              config="${KEY#*RPK_}"
              rpk redpanda config set --config /tmp/cfg.yml "${config,,}" "${!KEY}"
            done

            
            rpk cluster config import -f /tmp/cfg.yml
        securityContext:
          runAsGroup: 101
          runAsUser: 101
        volumeMounts:
          - name: config
            mountPath: /etc/redpanda
          - name: redpanda-default-cert
            mountPath: /etc/tls/certs/default
          - name: redpanda-external-cert
            mountPath: /etc/tls/certs/external
      volumes: 
        - name: config
          configMap:
            name: redpanda
        - name: redpanda-default-cert
          secret:
            secretName: redpanda-default-cert
            defaultMode: 0o440
        - name: redpanda-external-cert
          secret:
            secretName: redpanda-external-cert
            defaultMode: 0o440
      serviceAccountName: default
---
# Source: redpanda/templates/post-upgrade.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: redpanda-post-upgrade
  namespace: "redpanda"
  labels:
    app.kubernetes.io/component: redpanda
    app.kubernetes.io/instance: redpanda
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: redpanda
    helm.sh/chart: redpanda-5.7.37
  annotations:
    "helm.sh/hook": post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation
    "helm.sh/hook-weight": "-10"
spec:
  template:
    metadata:
      name: "redpanda"
      labels:
        app.kubernetes.io/name: redpanda
        app.kubernetes.io/instance: "redpanda"
        app.kubernetes.io/component: redpanda-post-upgrade
    spec:
      nodeSelector:
        node.kubernetes.io/broker: "true"
      affinity:
        {}
      restartPolicy: Never
      securityContext: 
        fsGroup: 101
        fsGroupChangePolicy: OnRootMismatch
      serviceAccountName: default
      containers:
      - name: redpanda-post-upgrade
        image: registry.gitlab.inria.fr/gkovilkk/greenflow/redpanda:v23.3.6
        command: ["/bin/bash", "-c"]
        args:
          - |
            set -e
            rpk cluster config set auto_create_topics_enabled true
            rpk cluster config set default_topic_partitions 300
    
            rpk cluster config set default_topic_replications 3
            rpk cluster config set storage_min_free_bytes 1073741824
            if [ -d "/etc/secrets/users/" ]; then
                IFS=":" read -r USER_NAME PASSWORD MECHANISM < <(grep "" $(find /etc/secrets/users/* -print))
                curl -svm3 --fail --retry "120" --retry-max-time "120" --retry-all-errors --ssl-reqd \
                --cacert /etc/tls/certs/default/ca.crt \
                -X PUT -u ${USER_NAME}:${PASSWORD} \
                https://redpanda.redpanda.svc.cluster.local.:9644/v1/debug/restart_service?service=schema-registry || true
            fi
        securityContext:
          runAsGroup: 101
          runAsUser: 101
        volumeMounts:
          - name: config
            mountPath: /etc/redpanda
          - name: redpanda-default-cert
            mountPath: /etc/tls/certs/default
          - name: redpanda-external-cert
            mountPath: /etc/tls/certs/external
      volumes: 
        - name: config
          configMap:
            name: redpanda
        - name: redpanda-default-cert
          secret:
            secretName: redpanda-default-cert
            defaultMode: 0o440
        - name: redpanda-external-cert
          secret:
            secretName: redpanda-external-cert
            defaultMode: 0o440
